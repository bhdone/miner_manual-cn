\chapter{挖矿指南}
\section{初始化空间（P盘）}
\begin{flushleft}
    初始化空间，俗称P盘。请参考Chia官方的网站上与P盘相关的信息。请注意，使用Chia的钱包生成的与私钥相关的Seed，在稍后需要复制到配置文件中，用来对区块进行签名。
\end{flushleft}
\section{下载节点程序}
\begin{flushleft}
    请访问BHD的官方网站（https://bhd.one）下载最新版本的BHD钱包，安装完成后，运行钱包程序则可以开始同步区块数据。注意，如果你在使用测试网络，请点击``绿色''图标的那个应用程序来运行节点程序，或者在命令行使用``btchdd.exe -testnet -server''来运行节点程序。
\end{flushleft}
\section{安装}
\begin{flushleft}
    双击下载好的安装包来安装钱包程序，当钱包程序安装完成后，将可以在开始菜单中找到与BitcoinHD相关的文件夹和程序图标。并且，在你打开了命令提示符的程序后，可以直接输入btchd-miner等相关的命令来执行一些操作。
\end{flushleft}
\subsection{添加搜索路径}
\begin{flushleft}
    安装完成后，你需要将BitcoinHD的daemon文件夹添加到系统的路径搜索列表里，具体操作如下：
\end{flushleft}
\begin{enumerate}
    \item 将BitcoinHD的安装目录的子目录``daemon''在资源管理器中复制下来，通常为``C:\symbol{92}Program Files\symbol{92}BitcoinHD\symbol{92}daemon''；
    \item 依次打开：Windows开始菜单-设置-系统-关于-高级系统设置-环境变量；
    \item 在打开的窗口里有两个列表，在上方的第一个列表中找到``path''项目，双击它打开路径编辑窗口；
    \item 点击``新建''按钮，将复制好的目录粘贴到列表中，然后点击确定保存；
    \item 重新打开你的命令行窗口，这时输入``btchd-miner.exe --help''后应该可以看到命令被正确调用；
\end{enumerate}
\subsection{配置节点RPC服务}
\begin{flushleft}
    默认的情况下，如果你使用GUI版本的钱包，它是不能直接与挖矿程序进行通讯的。如果你需要使用GUI版本的钱包来挖矿，则需要修改其配置：
\end{flushleft}
\begin{enumerate}
    \item 打开钱包，注：若是使用测试网络，请双击绿色的那个图标；
    \item 依次打开：设置-选项-配置文件，并且在弹出的提示框中点击``确定''；
    \item 在打开的文本编辑器中输入``server=1''，然后保存；
    \item 关闭钱包并重启，此时挖矿程序将可以正确连接；
\end{enumerate}
\section{编写配置文件}
\begin{flushleft}
    在开始挖矿工作前，需要先编写一个简单的配置文件，用于指定一些与挖矿工作相关的基本信息。
\end{flushleft}
\subsection{初始化配置文件}
\begin{flushleft}
    我们使用btchd-miner.exe来进行挖矿相关的工作，初始化一份空的配置文件，是它的其中一项功能。你也可以不使用它来初始化该文件，直接把已经撰写好的配置文件复制到你平常挖矿开始的目录中即可，我们在稍后启动挖矿程序时会需要指定该文件的位置。
\end{flushleft}
\begin{flushleft}
    使用下方的命令来初始化一份空的配置文件。
\end{flushleft}
\scriptsize
\begin{minted}{bash}
    btchd-miner.exe generate-config
\end{minted}
\normalsize
\begin{flushleft}
    使用任何的编辑器都可以编辑这个文件。关于如何修改这个文件，请查阅下一小节的内容。
\end{flushleft}
\subsection{填写配置}
\begin{flushleft}
    配置文件格式是Json文本，默认命名为``config.json''，下方是一个示例，你的配置文件看起来也会和下面的差不多。
\end{flushleft}
\scriptsize
\begin{minted}{json}
{
    "reward": "38CLnjuj31ifZMXZV8UhbyCo3fNP46Lszy",
    "seed": "bird convince trend skin lumber escape crater describe ...",
    "plotPath": [
        "/home/matthew/data/plotfiles1",
        "/home/matthew/data/plotfiles2"
    ],
    "rpc": {
        "host": "http://127.0.0.1:18732"
    }
}
\end{minted}
\normalsize
\subsubsection{BHD奖励地址}
\begin{flushleft}
    这是你在BHD网络中的接收挖矿奖励的地址。注意，在你使用这个地址前，需要确保已经将其与你的Chia的P盘文件相关的Farmer公钥相绑定，要了解如何进行绑定操作，请查阅``绑定FarmerId''一节。
\end{flushleft}
\subsubsection{Chia钱包seed}
\begin{flushleft}
    你在初始化硬盘空间的时候，Chia会需要你提供一个私钥，这个私钥由这个叫做``Seed''的字符串组成，里面是一些单词的组合。我们在产生BHD的区块时，需要用到这个私钥来对区块进行签名，用以验证你的身份。请将该``Seed''粘贴到这时。该私钥只用于签名，并且只保存在本地，不会被上传到BHD的链上或者网络中。
\end{flushleft}
\subsubsection{Plot文件目录}
\begin{flushleft}
    在这里你需要指定你的Plot文件目录，该登记项是一个数组，你可以同时登记多个Plot文件目录。
\end{flushleft}
\subsubsection{本地钱包的RPC连接}
\begin{flushleft}
    与本地钱包的RPC连接，如果你使用登录用户名称和密码，可以在这里指定。默认的我们使用``.cookie''文件来完成与钱包的通讯认证，所以在这里只需要登记``host''项即可。
\end{flushleft}
\section{基本参数介绍}
\subsection{节点程序``btchdd.exe''}
\subsubsection{参数}
\begin{itemize}
    \item ``-testnet''参数，启动测试网络的节点程序，若不带该参数则表示启动正式网络的节点程序
    \item ``-server''参数，启动RPC服务器，用以接收其它客户端，包括挖矿客户端的连接和命令
    \item ``-timelord''参数，启动时间证明
    \item ``-timelord-vdf\_client''参数，当指明了``-timelord''参数时，需要同时添加本参数来指定``vdf\_client''的路径
\end{itemize}
\begin{flushleft}
    注：与timelord相关的参数只能在Linux下运行，同时你需要编译chiavdf项目。``timelord''相关的参数，用于在本地计算并获取时间证明。关于时间证明的相关信息，可以参考BHD新版本的白皮书中与VDF相关的章节。另外，因为VDF计算暂时还没有Windows版本，若要运行VDF则需要使用Linux操作系统。因为每次出块，都需要获取与当前PoS相关的一个时间证明，所以，若在本地运行VDF则可以确保自己以在第一时间收到正确的证明答案。若没有在本地运行时间证明，那么需要通过网络将证明请求发送至可以计算证明的节点，在节点获得答案后会将其发回到本地。我们鼓励节点在本地运行时间证明，这样对于矿工本身和整个网络来说都是有益的。
\end{flushleft}\subsection{挖矿程序``btchd-miner.exe''}
\begin{flushleft}
    挖矿程序的参数由``主命令''和``命令参数''两部分组成。``主命令''指明当前要做的工作类型，``命令参数''将补全当前操作相关的参数。值得注意的是，指明``--no-proxy''参数用于跳过任何的本地网络代理设置，正常情况下建议都带上该参数，以避免可能出现的通讯问题。
\end{flushleft}
\subsubsection{命令列表}
\begin{flushleft}
    在执行挖矿程序时，使用参数``\mintinline{bash}{--help}''将显示出帮助文档。下方是一些重要的命令：
\end{flushleft}
\begin{itemize}
    \item ``mining''开始挖矿
    \item ``bind''绑定FarmerId
    \item ``deposit''质押金额
    \item ``withdraw''取出之前质押的金额
\end{itemize}
\section{绑定FarmerId}
\begin{flushleft}
    在挖矿开始前，你需要把你的BHD接收奖励的地址和FarmerId绑定，因为需要做签名，所以你需要先编写正确的配置文件并将你正确的``Seed''和BHD奖励地址填入。使用下方的命令来绑定FarmerId。
\end{flushleft}
\scriptsize
\begin{minted}{bash}
    btchd-miner.exe bind --testnet --no-proxy
\end{minted}
\normalsize
\begin{itemize}
    \item ``bind''为主命令
    \item ``\mintinline{bash}{--test}''参数，使用测试网络，若没有该参数则命令在主网上执行
    \item ``\mintinline{bash}{--no-proxy}''参数，跳过本地的proxy设置，直接连接到节点
\end{itemize}
\section{质押BHD}
\begin{flushleft}
    将BHD质押到网络上，以获取区块的完整收益，使用下面的命令来进行质押。
\end{flushleft}
\scriptsize
\begin{minted}{bash}
    btchd-miner.exe deposit --amount 质押数量 --term [noterm, term1, term2, term3] --testnet --no-proxy
\end{minted}
\normalsize
\begin{itemize}
    \item 其中``deposit''为主命令
    \item ``\mintinline{bash}{--amount}''参数，用于指定总共质押的货币数量
    \item ``\mintinline{bash}{--term}''参数，用于指定锁定的期限。其中：``noterm''为活期， ``term1'', ``term2'', ``term3''分别为不同的锁定期限类型
    \item ``\mintinline{bash}{--testnet}''参数，使用测试网络，若没有该参数则命令在主网上执行
    \item ``\mintinline{bash}{--no-proxy}''参数，跳过本地的proxy设置，直接连接到节点
\end{itemize}
\begin{flushleft}
    在质押成功后，``btchd-miner.exe''会显示出一个哈希值，这个哈希值是本次交易的``交易哈希''，请保存下来，未来需要退出质押或者重新绑定质押地址的时候使用。
\end{flushleft}
\section{质押转移}
\begin{flushleft}
    质押在链上的BHD将无法在约定的时间内被全额取出，但是可以将其转移给其它的矿工地址。
\end{flushleft}
\scriptsize
\begin{minted}{bash}
    btchd-miner.exe retarget --txid 交易哈希 --address 地址 --testnet --no-proxy
\end{minted}
\normalsize
\begin{itemize}
    \item 其中``retarget''为主命令
    \item ``\mintinline{bash}{--txid}''参数，用于指定将要被重新绑定的质押交易哈希
    \item ``\mintinline{bash}{--address}''参数，用于指定新的被绑定的地址
    \item ``\mintinline{bash}{--testnet}''参数，使用测试网络，若没有该参数则命令在主网上执行
    \item ``\mintinline{bash}{--no-proxy}''参数，跳过本地的proxy设置，直接连接到节点
\end{itemize}
\begin{flushleft}
    为了防止在短时间内某笔质押被频繁重绑，绑定操作有时间间隔规定。该次绑定与质押或上次绑定之间的区块数量不得小于一个既定值。在testnet3测试网上，该数值为10，在正式网络上为7个星期左右。一笔已经重新绑定过的质押可以被再次重绑，命令格式与上方描述相同，需要指定上一次重绑的交易哈希。另外，只有该质押的拥有者才可以转移该质押。
\end{flushleft}
\section{查询质押}
\begin{flushleft}
    你可以通过使用``\mintinline{bash}{btchd-cli}''命令来查询与当前账号相关的质押，通过这个命令你可以了解到相关的txid并将其用在质押命令上。在命令行中显示的内容是一个json的文本，如下方的示例显示，可以看到质押的交易哈希，金额，区块高度，类型等信息。
\end{flushleft}
\scriptsize
\begin{minted}{bash}
btchd-cli.exe -testnet listpledges
[
{
    "txid": "d88dc9991696fa95e088f13ccbec5970975a26e1f2434c3c7d0e78508c42d4f5",
    "amount": 50000.00000000,
    "from": "2NGWAccrksGM4TmefLN4qyW1kV7VpMngtBQ",
    "to": "2NGWAccrksGM4TmefLN4qyW1kV7VpMngtBQ",
    "category": "self",
    "payloadType": 24,
    "payloadTypeStr": "DATACARRIER_TYPE_CHIA_POINT_TERM_3",
    "blockhash": "10476179ce364d40b4f7e7e34ad42a36f33c16815653693bc7709b7d2f4496dc",
    "blocktime": 1675404017,
    "blockheight": 200175,
    "valid": true,
    "chia": true
}
]
\end{minted}
\normalsize
\section{退出质押}
\begin{flushleft}
    当质押的金额的锁定期限到达后，矿工们可以将质押的金额取出。使用下方的命令。
\end{flushleft}
\scriptsize
\begin{minted}{bash}
    btchd-miner.exe withdraw --txid 交易哈希 --testnet --no-proxy
\end{minted}
\normalsize
\begin{itemize}
    \item 其中``withdraw''为主命令
    \item ``\mintinline{bash}{--txid}''参数，指定``交易哈希''，这个``交易哈希''在之前使用``deposit''命令成功后会被显示出来。
    \item ``\mintinline{bash}{--no-proxy}''参数，跳过本地的proxy设置，直接连接到节点
\end{itemize}
\section{启动挖矿}
\subsection{启动节点程序}
\begin{flushleft}
    节点程序是整个BitcoinHD的核心，它用于区块的下载，校验以及产生。它同时也管理着本地钱包、私钥，对区块进行签名，维护P2P网络等重要的工作。若要处理网络事务，包含区块下载、校验和挖矿等，该节点程序需要一直保持运行状态。要启动节点程序，请使用下方的命令。
\end{flushleft}
\scriptsize
\begin{minted}{bash}
    btchdd.exe -testnet -server
\end{minted}
\normalsize
\begin{itemize}
    \item ``\mintinline{bash}{-testnet}''参数，表示启动测试网络的节点程序，若没有该参数则启动正式网络的节点程序
    \item ``\mintinline{bash}{-server}''参数，打开RPC服务器，用于稍后与挖矿程序进行通信
    \item ``\mintinline{bash}{--no-proxy}''参数，跳过本地的proxy设置，直接连接到节点
\end{itemize}
\subsection{启动挖矿程序}
\begin{flushleft}
    当一切都准备就绪后，包括节点已经将所有的区块都同步完成，则可以启动挖矿程序。使用下方的命令来启动。
\end{flushleft}
\scriptsize
\begin{minted}{bash}
    btchd-miner.exe mining --testnet --no-proxy
\end{minted}
\normalsize
\begin{itemize}
    \item ``mining''为主命令
    \item ``\mintinline{bash}{--testnet}''参数，使用测试网络，若没有该参数，则命令在主网上执行
    \item ``\mintinline{bash}{--no-proxy}''参数，跳过本地的proxy设置，直接连接到节点
\end{itemize}
