\chapter{挖矿指南}
\section{初始化空间（P盘）}
\begin{flushleft}
    初始化空间，俗称P盘。请参考Chia官方的网站上与P盘相关的信息。请注意，使用Chia的钱包生成的与私钥相关的Seed，在稍后需要复制到配置文件中，用来对区块进行签名。
\end{flushleft}
\section{下载节点程序}
\begin{flushleft}
    请访问BHD的官方网站（https://bhd.one）下载最新版本的BHD钱包，安装完成后，运行钱包程序则可以开始同步区块数据。注意，如果你在使用测试网络，请点击``绿色''图标的那个应用程序来运行节点程序，或者在命令行使用``btchdd.exe -testnet -server''来运行节点程序。
\end{flushleft}
\section{安装}
\begin{flushleft}
    双击下载好的安装包来安装钱包程序，当钱包程序安装完成后，将可以在开始菜单中找到与BitcoinHD相关的文件夹和程序图标。并且，在你打开了命令提示符的程序后，可以直接输入btchd-miner等相关的命令来执行一些操作。
\end{flushleft}
\subsection{添加搜索路径}
\begin{flushleft}
    安装完成后，你需要将BitcoinHD的daemon文件夹添加到系统的路径搜索列表里，具体操作如下：
\end{flushleft}
\begin{enumerate}
    \item 将BitcoinHD的安装目录的子目录``daemon''在资源管理器中复制下来，通常为``C:\symbol{92}Program Files\symbol{92}BitcoinHD\symbol{92}daemon''；
    \item 依次打开：Windows开始菜单-设置-系统-关于-高级系统设置-环境变量；
    \item 在打开的窗口里有两个列表，在上方的第一个列表中找到``path''项目，双击它打开路径编辑窗口；
    \item 点击``新建''按钮，将复制好的目录粘贴到列表中，然后点击确定保存；
    \item 重新打开你的命令行窗口，这时输入``btchd-miner.exe --help''后应该可以看到命令被正确调用；
\end{enumerate}
\subsection{配置节点RPC服务}
\begin{flushleft}
    默认的情况下，如果你使用GUI版本的钱包，它是不能直接与挖矿程序进行通讯的。如果你需要使用GUI版本的钱包来挖矿，则需要修改其配置：
\end{flushleft}
\begin{enumerate}
    \item 打开钱包，注：若是使用测试网络，请双击绿色的那个图标；
    \item 依次打开：设置-选项-配置文件，并且在弹出的提示框中点击``确定''；
    \item 在打开的文本编辑器中输入``server=1''，然后保存；
    \item 关闭钱包并重启，此时挖矿程序将可以正确连接；
\end{enumerate}
\section{编写配置文件}
\begin{flushleft}
    在开始挖矿工作前，需要先编写一个简单的配置文件，用于指定一些与挖矿工作相关的基本信息。
\end{flushleft}
\subsection{初始化配置文件}
\begin{flushleft}
    我们使用btchd-miner.exe来进行挖矿相关的工作，初始化一份空的配置文件，是它的其中一项功能。你也可以不使用它来初始化该文件，直接把已经撰写好的配置文件复制到你平常挖矿开始的目录中即可，我们在稍后启动挖矿程序时会需要指定该文件的位置。
\end{flushleft}
\begin{flushleft}
    使用下方的命令来初始化一份空的配置文件。
\end{flushleft}
\scriptsize
\begin{minted}{bash}
    btchd-miner.exe generate-config
\end{minted}
\normalsize
\begin{flushleft}
    使用任何的编辑器都可以编辑这个文件。关于如何修改这个文件，请查阅下一小节的内容。
\end{flushleft}
\subsection{填写配置}
\begin{flushleft}
    配置文件格式是Json文本，默认命名为``config.json''，下方是一个示例，你的配置文件看起来也会和下面的差不多。
\end{flushleft}
\scriptsize
\begin{minted}{json}
{
    "testnet": true,
    "noproxy": true,
    "reward": "38CLnjuj31ifZMXZV8UhbyCo3fNP46Lszy",
    "seed": "bird convince trend skin lumber escape crater describe ...",
    "plotPath": [
        "/home/matthew/data/plotfiles1",
        "/home/matthew/data/plotfiles2"
    ],
    "rpc": {
        "host": "http://127.0.0.1:18732"
    }
}
\end{minted}
\normalsize
\subsubsection{测试网络``testnet''}
\begin{flushleft}
    当其值为true时，使用测试网络，否则使用正式网络。
\end{flushleft}
\subsubsection{不使用网络代理``noproxy''}
\begin{flushleft}
    该值为true时，表示不使用网络代理来连接钱包，若无特殊的代理需求，请保持该选项值为true。
\end{flushleft}
\subsubsection{BHD奖励地址``reward''}
\begin{flushleft}
    这是你在BHD网络中的接收挖矿奖励的地址。注意，在你使用这个地址前，需要确保已经将其与你的Chia的P盘文件相关的Farmer公钥相绑定，要了解如何进行绑定操作，请查阅``绑定FarmerId''一节。
\end{flushleft}
\subsubsection{Chia钱包助词词``seed''}
\begin{flushleft}
    你在初始化硬盘空间的时候，Chia会需要你提供一个私钥，这个私钥由这个叫做``Seed''的字符串组成，里面是一些单词的组合。我们在产生BHD的区块时，需要用到这个私钥来对区块进行签名，用以验证你的身份。请将该``Seed''粘贴到这时。该私钥只用于签名，并且只保存在本地，不会被上传到BHD的链上或者网络中。
\end{flushleft}
\subsubsection{Plot文件目录``plotPath''}
\begin{flushleft}
    在这里你需要指定你的Plot文件目录，该登记项是一个数组，你可以同时登记多个Plot文件目录。
\end{flushleft}
\subsubsection{本地钱包的RPC连接``rpc''}
\begin{flushleft}
    与本地钱包的RPC连接，如果你使用登录用户名称和密码，可以在这里指定。默认的我们使用``.cookie''文件来完成与钱包的通讯认证，所以在这里只需要登记``host''项即可。
\end{flushleft}
\section{基本参数介绍}
\subsection{节点程序``btchdd.exe''}
\subsubsection{参数}
\begin{itemize}
    \item ``-testnet''参数，启动测试网络的节点程序，若不带该参数则表示启动正式网络的节点程序
    \item ``-server''参数，启动RPC服务器，用以接收其它客户端，包括挖矿客户端的连接和命令
    \item ``-timelord''参数，启动时间证明
    \item ``-timelord-vdf\_client''参数，当指明了``-timelord''参数时，需要同时添加本参数来指定``vdf\_client''的路径
\end{itemize}
\begin{flushleft}
    注：与timelord相关的参数只能在Linux下运行，同时你需要编译chiavdf项目。``timelord''相关的参数，用于在本地计算并获取时间证明。关于时间证明的相关信息，可以参考BHD新版本的白皮书中与VDF相关的章节。另外，因为VDF计算暂时还没有Windows版本，若要运行VDF则需要使用Linux操作系统。因为每次出块，都需要获取与当前PoS相关的一个时间证明，所以，若在本地运行VDF则可以确保自己以在第一时间收到正确的证明答案。若没有在本地运行时间证明，那么需要通过网络将证明请求发送至可以计算证明的节点，在节点获得答案后会将其发回到本地。我们鼓励节点在本地运行时间证明，这样对于矿工本身和整个网络来说都是有益的。
\end{flushleft}\subsection{挖矿程序``btchd-miner.exe''}
\begin{flushleft}
    挖矿程序的参数由``主命令''和``命令参数''两部分组成。``主命令''指明当前要做的工作类型，``命令参数''将补全当前操作相关的参数。
\end{flushleft}
\subsubsection{命令列表}
\begin{flushleft}
    在执行挖矿程序时，使用参数``\mintinline{bash}{--help}''将显示出帮助文档。下方是一些重要的命令：
\end{flushleft}
\begin{itemize}
    \item ``mining''开始挖矿
    \item ``bind''绑定FarmerId
    \item ``deposit''质押金额
    \item ``withdraw''取出之前质押的金额
\end{itemize}
\section{绑定FarmerId}
\begin{flushleft}
    在挖矿开始前，你需要把你的BHD接收奖励的地址和FarmerId绑定，因为需要做签名，所以你需要先编写正确的配置文件并将你正确的``Seed''和BHD奖励地址填入，然后使用下方的命令来进行绑定。
\end{flushleft}
\scriptsize
\begin{minted}{bash}
    btchd-miner.exe bind
\end{minted}
\normalsize
\begin{itemize}
    \item ``bind''为主命令
\end{itemize}
\section{查询绑定}
\begin{flushleft}
    当绑定完成后，可以通过``\mintinline{bash}{bind --check}''来查询绑定记录。
\end{flushleft}
\scriptsize
\begin{minted}{bash}
    btchd-miner bind --check

  --> txid: b6037724221c1a21b183596f25cfcf46da90ce87c67f4fb93d74dce5dd977463
    height: 200003
   address: 2NGWAccrksGM4TmefLN4qyW1kV7VpMngtBQ
    farmer: a7ecb9581e69e4ce968e5465764f29f519901d9bc892da89e3048b87ba820c8b04e17d726bfbb236e3f0e33f8a83851e
     valid: yes
    active: yes
\end{minted}
\normalsize
\begin{flushleft}
    查询出来的绑定交易信息包括：交易哈希``txid''，高度``height''，绑定出块地址``address''及chia的``farmer''公钥。另外还包括有效性标志``valid''，是否激活``active''。
\end{flushleft}
\section{质押BHD}
\begin{flushleft}
    将BHD质押到网络上，以获取区块的完整收益，使用下面的命令来进行质押。
\end{flushleft}
\scriptsize
\begin{minted}{bash}
    btchd-miner.exe deposit --amount 质押数量 --term [noterm, term1, term2, term3]
\end{minted}
\normalsize
\begin{itemize}
    \item 其中``deposit''为主命令
    \item ``\mintinline{bash}{--amount}''参数，用于指定总共质押的货币数量
    \item ``\mintinline{bash}{--term}''参数，用于指定锁定的期限。其中：``noterm''为活期， ``term1'', ``term2'', ``term3''分别为不同的锁定期限类型
\end{itemize}
\begin{flushleft}
    在质押成功后，``btchd-miner.exe''会显示出一个哈希值，这个哈希值是本次交易的``交易哈希''，请保存下来，未来需要退出质押或者重新绑定质押地址的时候使用。
\end{flushleft}
\section{质押转移}
\begin{flushleft}
    质押在链上的BHD将无法在约定的时间内被全额取出，但是可以将其转移给其它的矿工地址。
\end{flushleft}
\scriptsize
\begin{minted}{bash}
    btchd-miner.exe retarget --txid 交易哈希 --address 地址
\end{minted}
\normalsize
\begin{itemize}
    \item 其中``retarget''为主命令
    \item ``\mintinline{bash}{--txid}''参数，用于指定将要被重新绑定的质押交易哈希
    \item ``\mintinline{bash}{--address}''参数，用于指定新的被绑定的地址
\end{itemize}
\begin{flushleft}
    为了防止在短时间内某笔质押被频繁重绑，绑定操作有时间间隔规定。该次绑定与质押或上次绑定之间的区块数量不得小于一个既定值。在testnet3测试网上，该数值为10，在正式网络上为7个星期左右。一笔已经重新绑定过的质押可以被再次重绑，命令格式与上方描述相同，需要指定上一次重绑的交易哈希。另外，只有该质押的拥有者才可以转移该质押。
\end{flushleft}
\section{查询质押}
\begin{flushleft}
    你可以通过使用``\mintinline{bash}{deposit --check}''命令来查询与当前账号相关的质押，通过这个命令你可以了解到相关的txid并将其用在质押命令上。在命令行中显示的内容是一个json的文本，如下方的示例显示，可以看到质押的交易哈希，金额，区块高度，类型等信息。
\end{flushleft}
\scriptsize
\begin{minted}{bash}
    btchd-miner.exe deposit --check --valid

    200711 [ retarget ] 093d4b78b49fa30be40e9156b237184570b93a5003b15534bf39a50a001f6bbb -->
                        2Mu5hQRdDKNWYYMKNBDAMDFimjop3B5zwYM       123 BHD [ noterm ]
    200392 [ retarget ] 87e3b2ab348340708a2fa4c175e56a86b4986eedf71ef486943737c02c1cd271 -->
                        2Mu5hQRdDKNWYYMKNBDAMDFimjop3B5zwYM       500 BHD [ noterm ]
    200375 [   point  ] 9b55c36accd6728b62be283e23c8fa3560ae1ac0a7828682f53e26d7de6b326b -->
                        2NGWAccrksGM4TmefLN4qyW1kV7VpMngtBQ     10000 BHD [  term1 ]
    200326 [ retarget ] b88888a693c61a426b08d4121dff40ed24154d014419a9b0cccbddd03d795ea9 -->
                        2NGWAccrksGM4TmefLN4qyW1kV7VpMngtBQ     50000 BHD [ noterm ]
\end{minted}
\normalsize
\begin{flushleft}
    以上是一台测试机上的查询结果，一共查询出四条有效的质押记录，项目分别为
\end{flushleft}
\begin{itemize}
    \item 区块高度，这条质押交易被打包在哪个区块里
    \item 质押类型，point表示为未被转移的质押，retarget表示质押曾经被转移一次或多次
    \item 交易哈希，可以复制该哈希值用于质押转移
    \item 矿工地址，享有该质押的出块地址
    \item 质押金额及类型，这笔质押总共的质押量及质押的锁定类型，分别为：noterm-无，term1-锁定类型1，term2-锁定类型2，term3-锁定类型3
\end{itemize}
\section{退出质押}
\begin{flushleft}
    当质押的金额的锁定期限到达后，矿工们可以将质押的金额取出。使用下方的命令。
\end{flushleft}
\scriptsize
\begin{minted}{bash}
    btchd-miner.exe withdraw --txid 交易哈希
\end{minted}
\normalsize
\begin{itemize}
    \item 其中``withdraw''为主命令
    \item ``\mintinline{bash}{--txid}''参数，指定``交易哈希''，这个``交易哈希''在之前使用``deposit''命令成功后会被显示出来。
\end{itemize}
\section{启动挖矿}
\subsection{启动节点程序}
\begin{flushleft}
    节点程序是整个BitcoinHD的核心，它用于区块的下载，校验以及产生。它同时也管理着本地钱包、私钥，对区块进行签名，维护P2P网络等重要的工作。若要处理网络事务，包含区块下载、校验和挖矿等，该节点程序需要一直保持运行状态。要启动节点程序，请使用下方的命令。
\end{flushleft}
\scriptsize
\begin{minted}{bash}
    btchdd.exe -testnet -server
\end{minted}
\normalsize
\begin{itemize}
    \item ``\mintinline{bash}{-testnet}''参数，表示启动测试网络的节点程序，若没有该参数则启动正式网络的节点程序
    \item ``\mintinline{bash}{-server}''参数，打开RPC服务器，用于稍后与挖矿程序进行通信
\end{itemize}
\subsection{启动挖矿程序}
\begin{flushleft}
    当一切都准备就绪后，包括节点已经将所有的区块都同步完成，则可以启动挖矿程序。使用下方的命令来启动。
\end{flushleft}
\scriptsize
\begin{minted}{bash}
    btchd-miner.exe mining
\end{minted}
\normalsize
\begin{itemize}
    \item ``mining''为主命令
\end{itemize}
